#!/usr/bin/env ruby
require "rubygems"
require "bundler/setup"
require File.dirname(__FILE__) + "/../lib/tumblr"
require 'thor'

class TumblrCommand < Thor
  desc "post", "Posts a photo from a url to tumblr"
  def post(host, url)
    require "tumblr/credentials"
    cred = Tumblr::Credentials.new.read
    invoke :authorize if cred.empty?
    client = Tumblr::Client.load(host)
    photo = Tumblr::Post::Photo.new(:source => url, :caption => "I posted this using the bleeding edge of the new Tumblr Command Line utility for #fashionhack day.")
    response = photo.post(client).perform
    puts response.body
  end

  desc "authorize", "Authenticate and authorize the cli"
  def authorize(*soak)
    Tumblr::Authentication.run! do |server|
      `open http://localhost:4567/`
    end
  end
end

TumblrCommand.start


